# Remove rows with invalid Longitude or Latitude values
hospital_summary <- hospital_summary[!is.na(as.numeric(hospital_summary$Longitude)) & !is.na(as.numeric(hospital_summary$Latitude)), ]

# Ensure Longitude and Latitude are numeric
hospital_summary$Longitude <- as.numeric(hospital_summary$Longitude)
hospital_summary$Latitude <- as.numeric(hospital_summary$Latitude)

# Render Leaflet map
# Render Leaflet map
output$map <- renderLeaflet({
  # Define the counties to highlight
  highlighted_counties <- c("Machakos", "Nairobi", "Mombasa", "Kisumu")
  
  # Filter the shapefile data to only include the highlighted counties
  map_filtered <- map[map$Name %in% highlighted_counties, ]
  
  # Define color palette for number of Candida isolated
  pal <- colorBin("YlOrBr", domain = hospital_summary$Candida_isolated, bins = 3)
  
  # Define labels for hospitals showing screened patients and Candida isolated
  labels <- lapply(1:nrow(hospital_summary), function(i) {
    html <- paste0("<strong>", hospital_summary$Hospital[i], "</strong><br>",
                   "Screened patients: ", hospital_summary$Screened_patients[i], "<br>",
                   "Candida species: ", hospital_summary$Candida_isolated[i])
    htmltools::HTML(html)
  })
  
  # Render Leaflet map with filtered shapefile and markers
  leaflet() %>%
    addTiles() %>%
    addPolygons(data = map_filtered,
                color = "orange",
                dashArray = "1",
                fillOpacity = 0.4,
                highlightOptions = highlightOptions(
                  weight = 2,
                  color = "#666",
                  dashArray = "",
                  fillOpacity = 0.1,
                  bringToFront = TRUE
                )) %>%
    addMarkers(data = hospital_summary,
               lng = ~Longitude,
               lat = ~Latitude,
               popup = labels,
               label = labels,
               labelOptions = labelOptions(
                 style = list("font-weight" = "bold", padding = "8px"),
                 direction = "auto"
               )) %>%
    setView(lng = 36.8220, lat = -1.7918, zoom = 7)
})


